// Variable Declarations

/*int sinwave[120] = {
  // Sin wave
  
    0x7ff, 0x86a, 0x8d5, 0x93f, 0x9a9, 0xa11, 0xa78, 0xadd, 0xb40, 0xba1,
    0xbff, 0xc5a, 0xcb2, 0xd08, 0xd59, 0xda7, 0xdf1, 0xe36, 0xe77, 0xeb4,
    0xeec, 0xf1f, 0xf4d, 0xf77, 0xf9a, 0xfb9, 0xfd2, 0xfe5, 0xff3, 0xffc,
    0xfff, 0xffc, 0xff3, 0xfe5, 0xfd2, 0xfb9, 0xf9a, 0xf77, 0xf4d, 0xf1f,
    0xeec, 0xeb4, 0xe77, 0xe36, 0xdf1, 0xda7, 0xd59, 0xd08, 0xcb2, 0xc5a,
    0xbff, 0xba1, 0xb40, 0xadd, 0xa78, 0xa11, 0x9a9, 0x93f, 0x8d5, 0x86a,
    0x7ff, 0x794, 0x729, 0x6bf, 0x655, 0x5ed, 0x586, 0x521, 0x4be, 0x45d,
    0x3ff, 0x3a4, 0x34c, 0x2f6, 0x2a5, 0x257, 0x20d, 0x1c8, 0x187, 0x14a,
    0x112, 0xdf, 0xb1, 0x87, 0x64, 0x45, 0x2c, 0x19, 0xb, 0x2,
    0x0, 0x2, 0xb, 0x19, 0x2c, 0x45, 0x64, 0x87, 0xb1, 0xdf,
    0x112, 0x14a, 0x187, 0x1c8, 0x20d, 0x257, 0x2a5, 0x2f6, 0x34c, 0x3a4,
    0x3ff, 0x45d, 0x4be, 0x521, 0x586, 0x5ed, 0x655, 0x6bf, 0x729, 0x794
};*/

int sinwave[] = {3226, 3226, 3225, 3223, 3220, 3216, 3211, 3204, 3196, 3188, 3178, 3167, 3154, 3141, 3126, 3111, 3094, 3076, 3058, 3038, 3017, 2995, 2973, 2949, 2924, 2899, 2873, 2845, 2818, 2789, 2759, 2729, 2698, 2666, 2634, 2601, 2568, 2534, 2499, 2464, 2429, 2393, 2357, 2321, 2284, 2247, 2209, 2172, 2134, 2097, 2059, 2021, 1983, 1945, 1908, 1870, 1833, 1795, 1758, 1722, 1685, 1649, 1613, 1578, 1543, 1508, 1475, 1441, 1408, 1376, 1344, 1314, 1283, 1254, 1225, 1197, 1170, 1144, 1118, 1094, 1070, 1047, 1026, 1005, 985, 967, 949, 932, 917, 902, 889, 877, 866, 856, 847, 839, 833, 828, 824, 821, 819, 819, 819, 821, 824, 828, 834, 840, 848, 857, 867, 878, 890, 904, 918, 934, 951, 968, 987, 1007, 1028, 1050, 1072, 1096, 1121, 1146, 1173, 1200, 1228, 1257, 1286, 1317, 1348, 1379, 1412, 1444, 1478, 1512, 1546, 1581, 1617, 1653, 1689, 1725, 1762, 1799, 1836, 1874, 1912, 1949, 1987, 2025, 2063, 2100, 2138, 2176, 2213, 2250, 2287, 2324, 2361, 2397, 2433, 2468, 2503, 2537, 2571, 2605, 2637, 2670, 2701, 2732, 2762, 2792, 2820, 2848, 2875, 2902, 2927, 2951, 2975, 2998, 3019, 3040, 3060, 3078, 3096, 3112, 3128, 3142, 3156, 3168, 3179, 3189, 3197, 3205, 3211, 3216, 3221, 3223, 3225, 3225, 3225, 3223, 3220, 3216, 3210, 3203, 3196, 3187, 3177, 3165, 3153, 3140, 3125, 3109, 3092, 3075, 3056, 3036, 3015, 2993, 2970, 2947, 2922, 2896, 2870, 2843, 2815, 2786, 2756, 2726, 2695, 2663, 2631, 2598, 2564, 2530, 2496, 2461, 2425, 2390, 2353, 2317, 2280, 2243, 2206, 2168, 2131, 2093, 2055, 2017, 1979, 1942, 1904, 1866, 1829, 1792, 1755, 1718, 1682, 1645, 1610, 1574, 1539, 1505, 1471, 1438, 1405, 1373, 1341, 1310, 1280, 1251, 1222, 1194, 1167, 1141, 1116, 1091, 1068, 1045, 1024, 1003, 983, 965, 947, 931, 915, 901, 888, 876, 865, 855, 846, 839, 832, 827, 823, 821, 819, 819, 819, 821, 824, 829, 834, 841, 849, 858, 868, 879, 892, 905, 920, 936, 952, 970, 989, 1009, 1030, 1052, 1075, 1099, 1123, 1149, 1175, 1203, 1231, 1260, 1289, 1320, 1351, 1382, 1415, 1448, 1481, 1515, 1550, 1585, 1620, 1656, 1692, 1729, 1766, 1803, 1840, 1878, 1915, 1953, 1991, 2029, 2066, 2104, 2142, 2179, 2217, 2254, 2291, 2328, 2364, 2400, 2436, 2471, 2506, 2541, 2575, 2608, 2641, 2673, 2704, 2735, 2765, 2795, 2823, 2851, 2878, 2904, 2929, 2954, 2977, 3000, 3021, 3042, 3062, 3080, 3098, 3114, 3129, 3144, 3157, 3169, 3180, 3190, 3198, 3206, 3212, 3217, 3221, 3224, 3225, 3225, 3225, 3223, 3219, 3215, 3209, 3203, 3195, 3186, 3176, 3164, 3152, 3138, 3123, 3108, 3091, 3073, 3054, 3034, 3013, 2991, 2968, 2944, 2919, 2894, 2867, 2840, 2812, 2783, 2753, 2723, 2692, 2660, 2628, 2595, 2561, 2527, 2492, 2457, 2422, 2386, 2350, 2313, 2276, 2239, 2202, 2164, 2127, 2089, 2051, 2013, 1976, 1938, 1900, 1863, 1825, 1788, 1751, 1714, 1678, 1642, 1606, 1571, 1536, 1502, 1468, 1435, 1402, 1370, 1338, 1307, 1277, 1248, 1219, 1192, 1165, 1139, 1113, 1089, 1066, 1043, 1022, 1001, 981, 963, 946, 929, 914, 900, 887, 875, 864, 854, 845, 838, 832, 827, 823, 820, 819, 819, 819, 822, 825, 829, 835, 842, 850, 859, 869, 880, 893, 907, 921, 937, 954, 972, 991, 1011, 1032, 1054, 1077, 1101, 1126, 1152, 1178, 1205, 1234, 1263, 1292, 1323, 1354, 1386, 1418, 1451, 1485, 1519, 1553, 1588, 1624, 1660, 1696, 1733, 1769, 1807, 1844, 1881, 1919, 1957, 1995, 2032, 2070, 2108, 2146, 2183, 2221, 2258, 2295, 2332, 2368, 2404, 2440, 2475, 2510, 2544, 2578, 2611, 2644, 2676, 2707, 2738, 2768, 2797, 2826, 2854, 2881, 2907, 2932, 2956, 2980, 3002, 3024, 3044, 3063, 3082, 3099, 3116, 3131, 3145, 3158, 3170, 3181, 3190, 3199, 3206, 3212, 3217, 3221, 3224, 3225, 3225, 3224, 3222, 3219, 3215, 3209, 3202, 3194, 3185, 3174, 3163, 3150, 3137, 3122, 3106, 3089, 3071, 3052, 3032, 3011, 2989, 2966, 2942, 2917, 2891, 2865, 2837, 2809, 2780, 2750, 2720, 2689, 2657, 2624, 2591, 2558, 2524, 2489, 2454, 2418, 2382, 2346, 2310, 2273, 2236, 2198, 2161, 2123, 2085, 2048, 2010, 1972, 1934, 1896, 1859, 1822, 1784, 1747, 1711, 1674, 1638, 1603, 1567, 1533, 1498, 1464, 1431, 1399, 1367, 1335, 1304, 1274, 1245, 1217, 1189, 1162, 1136, 1111, 1087, 1063, 1041, 1019, 999, 980, 961, 944, 928, 912, 898, 885, 873, 863, 853, 845, 837, 831, 826, 823, 820, 819, 819, 820, 822, 825, 830, 835, 842, 850, 860, 870, 882, 894, 908, 923, 939, 956, 974, 993, 1013, 1034, 1056, 1079, 1103, 1128, 1154, 1181, 1208, 1236, 1266, 1295, 1326, 1357, 1389, 1421, 1454, 1488, 1522, 1557, 1592, 1628, 1663, 1700, 1736, 1773, 1810, 1848, 1885, 1923, 1961, 1998, 2036, 2074, 2112, 2149, 2187, 2224, 2262, 2298, 2335, 2372, 2408, 2443, 2478, 2513, 2547, 2581, 2614, 2647, 2679, 2710, 2741, 2771, 2800, 2829, 2856, 2883, 2909, 2934, 2959, 2982, 3004, 3026, 3046, 3065, 3084, 3101, 3117, 3132, 3146, 3159, 3171, 3182, 3191, 3200, 3207, 3213, 3218, 3221, 3224, 3225, 3225, 3224, 3222, 3219, 3214, 3208, 3201, 3193, 3184, 3173, 3162, 3149, 3135, 3120, 3104, 3087, 3069, 3050, 3030, 3009, 2986, 2963, 2939, 2914, 2889, 2862, 2834, 2806, 2777, 2747, 2717, 2685, 2654, 2621, 2588, 2554, 2520, 2485, 2450, 2415, 2379, 2342, 2306, 2269, 2232, 2194, 2157, 2119, 2082, 2044, 2006, 1968, 1930, 1893, 1855, 1818, 1781, 1744, 1707, 1671, 1635, 1599, 1564, 1529, 1495, 1461, 1428, 1395, 1363, 1332, 1301, 1271, 1242, 1214, 1186, 1159, 1133, 1108, 1084, 1061, 1039, 1017, 997, 978, 959, 942, 926, 911, 897, 884, 872, 862, 852, 844, 837, 831, 826, 822, 820, 819, 819, 820, 822, 826, 830, 836, 843, 851, 861, 871, 883, 896, 909, 924, 941, 958, 976, 995, 1015, 1036, 1059, 1082, 1106, 1131, 1157, 1183, 1211, 1239, 1268, 1298, 1329, 1360, 1392, 1425, 1458, 1491, 1526, 1560, 1596, 1631, 1667, 1703, 1740, 1777, 1814, 1851, 1889, 1927, 1964, 2002, 2040, 2078, 2116, 2153, 2191, 2228, 2265, 2302, 2339, 2375, 2411, 2447, 2482, 2517, 2551, 2585, 2618, 2650, 2682, 2714, 2744, 2774, 2803, 2832, 2859, 2886, 2912, 2937, 2961, 2984, 3006, 3028, 3048, 3067, 3085, 3103, 3119, 3134, 3148, 3161, 3172, 3183, 3192, 3200, 3208, 3213, 3218, 3222, 3224, 3225, 3225, 3224, 3222, 3218, 3213, 3208, 3200, 3192, 3183, 3172, 3161, 3148, 3134, 3119, 3103, 3085, 3067, 3048, 3028, 3006, 2984, 2961, 2937, 2912, 2886, 2859, 2832, 2803, 2774, 2744, 2714, 2682, 2650, 2618, 2585, 2551, 2517, 2482, 2447, 2411, 2375, 2339, 2302, 2265, 2228, 2191, 2153, 2116, 2078, 2040, 2002, 1964, 1927, 1889, 1851, 1814, 1777, 1740, 1703, 1667, 1631, 1596, 1560, 1526, 1491, 1458, 1425, 1392, 1360, 1329, 1298, 1268, 1239, 1211, 1183, 1157, 1131, 1106, 1082, 1059, 1036, 1015, 995, 976, 958, 941, 924, 909, 896, 883, 871, 861, 851, 843, 836, 830, 826, 822, 820, 819, 819, 820, 822, 826, 831, 837, 844, 852, 862, 872, 884, 897, 911, 926, 942, 959, 978, 997, 1017, 1039, 1061, 1084, 1108, 1133, 1159, 1186, 1214, 1242, 1271, 1301, 1332, 1363, 1395, 1428, 1461, 1495, 1529, 1564, 1599, 1635, 1671, 1707, 1744, 1781, 1818, 1855, 1893, 1930, 1968, 2006, 2044, 2082, 2119, 2157, 2194, 2232, 2269, 2306, 2342, 2379, 2415, 2450, 2485, 2520, 2554, 2588, 2621, 2654, 2685, 2717, 2747, 2777, 2806, 2834, 2862, 2889, 2914, 2939, 2963, 2986, 3009, 3030, 3050, 3069, 3087, 3104, 3120, 3135, 3149, 3162, 3173, 3184, 3193, 3201, 3208, 3214, 3219, 3222, 3224, 3225, 3225, 3224, 3221, 3218, 3213, 3207, 3200, 3191, 3182, 3171, 3159, 3146, 3132, 3117, 3101, 3084, 3065, 3046, 3026, 3004, 2982, 2959, 2934, 2909, 2883, 2856, 2829, 2800, 2771, 2741, 2710, 2679, 2647, 2614, 2581, 2547, 2513, 2478, 2443, 2408, 2372, 2335, 2298, 2262, 2224, 2187, 2149, 2112, 2074, 2036, 1998, 1961, 1923, 1885, 1848, 1810, 1773, 1736, 1700, 1663, 1628, 1592, 1557, 1522, 1488, 1454, 1421, 1389, 1357, 1326, 1295, 1266, 1236, 1208, 1181, 1154, 1128, 1103, 1079, 1056, 1034, 1013, 993, 974, 956, 939, 923, 908, 894, 882, 870, 860, 850, 842, 835, 830, 825, 822, 820, 819, 819, 820, 823, 826, 831, 837, 845, 853, 863, 873, 885, 898, 912, 928, 944, 961, 980, 999, 1019, 1041, 1063, 1087, 1111, 1136, 1162, 1189, 1217, 1245, 1274, 1304, 1335, 1367, 1399, 1431, 1464, 1498, 1533, 1567, 1603, 1638, 1674, 1711, 1747, 1784, 1822, 1859, 1896, 1934, 1972, 2010, 2048, 2085, 2123, 2161, 2198, 2236, 2273, 2310, 2346, 2382, 2418, 2454, 2489, 2524, 2558, 2591, 2624, 2657, 2689, 2720, 2750, 2780, 2809, 2837, 2865, 2891, 2917, 2942, 2966, 2989, 3011, 3032, 3052, 3071, 3089, 3106, 3122, 3137, 3150, 3163, 3174, 3185, 3194, 3202, 3209, 3215, 3219, 3222, 3224, 3225, 3225, 3224, 3221, 3217, 3212, 3206, 3199, 3190, 3181, 3170, 3158, 3145, 3131, 3116, 3099, 3082, 3063, 3044, 3024, 3002, 2980, 2956, 2932, 2907, 2881, 2854, 2826, 2797, 2768, 2738, 2707, 2676, 2644, 2611, 2578, 2544, 2510, 2475, 2440, 2404, 2368, 2332, 2295, 2258, 2221, 2183, 2146, 2108, 2070, 2032, 1995, 1957, 1919, 1881, 1844, 1807, 1769, 1733, 1696, 1660, 1624, 1588, 1553, 1519, 1485, 1451, 1418, 1386, 1354, 1323, 1292, 1263, 1234, 1205, 1178, 1152, 1126, 1101, 1077, 1054, 1032, 1011, 991, 972, 954, 937, 921, 907, 893, 880, 869, 859, 850, 842, 835, 829, 825, 822, 819, 819, 819, 820, 823, 827, 832, 838, 845, 854, 864, 875, 887, 900, 914, 929, 946, 963, 981, 1001, 1022, 1043, 1066, 1089, 1113, 1139, 1165, 1192, 1219, 1248, 1277, 1307, 1338, 1370, 1402, 1435, 1468, 1502, 1536, 1571, 1606, 1642, 1678, 1714, 1751, 1788, 1825, 1863, 1900, 1938, 1976, 2013, 2051, 2089, 2127, 2164, 2202, 2239, 2276, 2313, 2350, 2386, 2422, 2457, 2492, 2527, 2561, 2595, 2628, 2660, 2692, 2723, 2753, 2783, 2812, 2840, 2867, 2894, 2919, 2944, 2968, 2991, 3013, 3034, 3054, 3073, 3091, 3108, 3123, 3138, 3152, 3164, 3176, 3186, 3195, 3203, 3209, 3215, 3219, 3223, 3225, 3225, 3225, 3224, 3221, 3217, 3212, 3206, 3198, 3190, 3180, 3169, 3157, 3144, 3129, 3114, 3098, 3080, 3062, 3042, 3021, 3000, 2977, 2954, 2929, 2904, 2878, 2851, 2823, 2795, 2765, 2735, 2704, 2673, 2641, 2608, 2575, 2541, 2506, 2471, 2436, 2400, 2364, 2328, 2291, 2254, 2217, 2179, 2142, 2104, 2066, 2029, 1991, 1953, 1915, 1878, 1840, 1803, 1766, 1729, 1692, 1656, 1620, 1585, 1550, 1515, 1481, 1448, 1415, 1382, 1351, 1320, 1289, 1260, 1231, 1203, 1175, 1149, 1123, 1099, 1075, 1052, 1030, 1009, 989, 970, 952, 936, 920, 905, 892, 879, 868, 858, 849, 841, 834, 829, 824, 821, 819, 819, 819, 821, 823, 827, 832, 839, 846, 855, 865, 876, 888, 901, 915, 931, 947, 965, 983, 1003, 1024, 1045, 1068, 1091, 1116, 1141, 1167, 1194, 1222, 1251, 1280, 1310, 1341, 1373, 1405, 1438, 1471, 1505, 1539, 1574, 1610, 1645, 1682, 1718, 1755, 1792, 1829, 1866, 1904, 1942, 1979, 2017, 2055, 2093, 2131, 2168, 2206, 2243, 2280, 2317, 2353, 2390, 2425, 2461, 2496, 2530, 2564, 2598, 2631, 2663, 2695, 2726, 2756, 2786, 2815, 2843, 2870, 2896, 2922, 2947, 2970, 2993, 3015, 3036, 3056, 3075, 3092, 3109, 3125, 3140, 3153, 3165, 3177, 3187, 3196, 3203, 3210, 3216, 3220, 3223, 3225, 3225, 3225, 3223, 3221, 3216, 3211, 3205, 3197, 3189, 3179, 3168, 3156, 3142, 3128, 3112, 3096, 3078, 3060, 3040, 3019, 2998, 2975, 2951, 2927, 2902, 2875, 2848, 2820, 2792, 2762, 2732, 2701, 2670, 2637, 2605, 2571, 2537, 2503, 2468, 2433, 2397, 2361, 2324, 2287, 2250, 2213, 2176, 2138, 2100, 2063, 2025, 1987, 1949, 1912, 1874, 1836, 1799, 1762, 1725, 1689, 1653, 1617, 1581, 1546, 1512, 1478, 1444, 1412, 1379, 1348, 1317, 1286, 1257, 1228, 1200, 1173, 1146, 1121, 1096, 1072, 1050, 1028, 1007, 987, 968, 951, 934, 918, 904, 890, 878, 867, 857, 848, 840, 834, 828, 824, 821, 819, 819, 819, 821, 824, 828, 833, 839, 847, 856, 866, 877, 889, 902, 917, 932, 949, 967, 985, 1005, 1026, 1047, 1070, 1094, 1118, 1144, 1170, 1197, 1225, 1254, 1283, 1314, 1344, 1376, 1408, 1441, 1475, 1508, 1543, 1578, 1613, 1649, 1685, 1722, 1758, 1795, 1833, 1870, 1908, 1945, 1983, 2021, 2059, 2097, 2134, 2172, 2209, 2247, 2284, 2321, 2357, 2393, 2429, 2464, 2499, 2534, 2568, 2601, 2634, 2666, 2698, 2729, 2759, 2789, 2818, 2845, 2873, 2899, 2924, 2949, 2973, 2995, 3017, 3038, 3058, 3076, 3094, 3111, 3126, 3141, 3154, 3167, 3178, 3188, 3196, 3204, 3211, 3216, 3220, 3223, 3225, 3226};
uint32_t FS = 2e3;
float TS = 1/float(FS) * 1000000;

int ControlInputPin = 55;			// Sensor pin value
int SensorOutputPin = 9;			// Trigger pin value
int i=0, j=0;                                // loop indexes
char buf[10];			        // string buffer
char buf2[10];			        // string buffer
unsigned long Time;		        // One time marker
unsigned long iniTime;		        // One time marker
int ledPin = 13;
int ControlInput = 0;
int SensorOutput = 0;
int State = 0;

const float K = 1.5;
const uint32_t MIN_DAC_VALUE = 683;
const uint32_t MAX_DAC_VALUE = 3413;
uint32_t aux_input = 0;

void setup() {
  // put your setup code here, to run once:
   //     Serial.begin(9600); 
   //     Serial.println("Initialisation Started");
        analogReadResolution(12);
        analogWriteResolution(12);
     //   Serial.println("Initialisation Done");
        iniTime=millis();       
      // Serial.println("We have a go"); 
       pinMode(ledPin, OUTPUT);
}

void loop() {
  if (i == 1000) {
    i=0;
  }
  
  // Reading control value, averaged 10 times
  ControlInput=0;
  j=0;

  aux_input = analogRead(ControlInputPin);
  if (aux_input < MIN_DAC_VALUE) {
    aux_input = 0;
  }
  else if (aux_input > MAX_DAC_VALUE) {
    aux_input = 4095;
  }
  else {
    aux_input = (aux_input - MIN_DAC_VALUE) * K;
  }
  
  ControlInput = aux_input;
  /* Implementing the problem*/ 
  
  /* State = (sinwave[i] / float(4095)) / 3 + 0.5;
  State = State - ControlInput;*/
  State = sinwave[i] - ControlInput;
  if (State < 0) {
    State = 0;
  }
  else if (State > 4095) {
    State = 4095;
  }
  SensorOutput = int(State);
  
  analogWrite(DAC0, SensorOutput);
  analogWrite(DAC1  , sinwave[i]);
  analogWrite(ledPin,int(State*255));
  
  // Time=millis()-iniTime;
  // Serial.println("Datablock");
  // sprintf(buf,"%e hh\n",SensorOutput                                                                   );  	// " hh" is used to avoid unerased numbers 						// in the buffer. Any other string can be used.
  // Serial.print(buf);
  //sprintf(buf2,"%e hh\n",Time*1.0);  	// " hh" is used to avoid unerased numbers 						// in the buffer. Any other string can be used.
  //delay(1);
  //Serial.print(buf2);
  //delay(1);
  i++;
  delayMicroseconds(TS);
}
